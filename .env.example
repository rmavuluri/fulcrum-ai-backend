# Server
PORT=3001
FRONTEND_URL=http://localhost:5173

# Ally sandbox (get token + call sandbox for /api/chat)
USE_ALLY_SANDBOX=1
SANDBOX_CLIENT_KEY=your-client-key
SANDBOX_CLIENT_SECRET=your-client-secret

# Optional overrides (defaults shown)
# ALLY_SANDBOX_MODEL_ID=openai.gpt-35-turbo-16k
# ALLY_TOKEN_ENDPOINT=https://dev.api.ally.com/v1/access/token
# ALLY_SANDBOX_PROMPT_URL=https://dev.api.ally.com/amh-gpt-sandbox/shared/curated/prompt


/**
 * Masks sensitive data inside strings.
 * Handles:
 *  - Emails
 *  - Long numeric sequences (>=4 digits)
 *  - Mixed content strings
 */
export function maskPII(input: any): any {
  if (input === null || input === undefined) return input;

  // If it's a number, mask completely
  if (typeof input === "number") {
    const str = String(input);
    if (str.length <= 2) return "**";
    return "*".repeat(str.length - 2) + str.slice(-2);
  }

  if (typeof input !== "string") return input;

  let s = input;

  // 1️⃣ Mask emails
  s = s.replace(
    /\b([A-Z0-9._%+-]+)@([A-Z0-9.-]+\.[A-Z]{2,})\b/gi,
    (_, user, domain) => {
      if (user.length <= 2) return `**@${domain}`;
      return `${user[0]}***${user[user.length - 1]}@${domain}`;
    }
  );

  // 2️⃣ Mask long numeric sequences (>=4 digits)
  s = s.replace(/\b\d{4,}\b/g, (match) => {
    if (match.length <= 2) return "**";
    return "*".repeat(match.length - 2) + match.slice(-2);
  });

  return s;
}


/**
 * Recursively sanitizes error objects, arrays, and strings.
 * Safe for logging in production environments.
 */
export function sanitizeErrors(errors: any): any {
  const seen = new WeakSet();

  function deepSanitize(value: any): any {
    if (value === null || value === undefined) return value;

    // Prevent circular reference crash
    if (typeof value === "object") {
      if (seen.has(value)) return "[Circular]";
      seen.add(value);
    }

    // Mask strings and numbers
    if (typeof value === "string" || typeof value === "number") {
      return maskPII(value);
    }

    // Handle arrays
    if (Array.isArray(value)) {
      return value.map((item) => deepSanitize(item));
    }

    // Handle objects
    if (typeof value === "object") {
      const sanitized: Record<string, any> = {};
      for (const key of Object.keys(value)) {
        sanitized[key] = deepSanitize(value[key]);
      }
      return sanitized;
    }

    return value;
  }

  try {
    return deepSanitize(errors);
  } catch (err) {
    return maskPII(String(errors));
  }
}