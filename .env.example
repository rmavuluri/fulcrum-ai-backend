# Server
PORT=3001
FRONTEND_URL=http://localhost:5173

# Ally sandbox (get token + call sandbox for /api/chat)
USE_ALLY_SANDBOX=1
SANDBOX_CLIENT_KEY=your-client-key
SANDBOX_CLIENT_SECRET=your-client-secret

# Optional overrides (defaults shown)
# ALLY_SANDBOX_MODEL_ID=openai.gpt-35-turbo-16k
# ALLY_TOKEN_ENDPOINT=https://dev.api.ally.com/v1/access/token
# ALLY_SANDBOX_PROMPT_URL=https://dev.api.ally.com/amh-gpt-sandbox/shared/curated/prompt


const SENSITIVE_KEY_REGEX =
  /(customer_id|parent_id|reference_id|phone|phone_number|account|accounts|ssn|email|address)/i;

/**
 * Mask digits inside a string:
 * - any digit sequence length >= 4 gets masked except last 2 digits
 *   e.g., 104935 -> ****35, 9893434545 -> ********45
 */
function maskDigitsInText(text: string): string {
  return text.replace(/\d{4,}/g, (m) => {
    if (m.length <= 2) return "**";
    return "*".repeat(m.length - 2) + m.slice(-2);
  });
}

/**
 * Mask emails inside a string.
 */
function maskEmailsInText(text: string): string {
  return text.replace(
    /\b([A-Z0-9._%+-]+)@([A-Z0-9.-]+\.[A-Z]{2,})\b/gi,
    (_, user, domain) => {
      if (!user) return `***@${domain}`;
      if (user.length <= 2) return `**@${domain}`;
      return `${user[0]}***${user[user.length - 1]}@${domain}`;
    }
  );
}

/**
 * Mask PII for primitive values.
 * - strings: mask emails + digit sequences
 * - numbers: mask like digits (keep last 2)
 */
export function maskPII(input: any): any {
  if (input === null || input === undefined) return input;

  if (typeof input === "number") {
    const s = String(input);
    if (s.length <= 2) return "**";
    return "*".repeat(s.length - 2) + s.slice(-2);
  }

  if (typeof input !== "string") return input;

  let s = input;
  s = maskEmailsInText(s);
  s = maskDigitsInText(s);
  return s;
}

/**
 * Deep sanitize:
 * - recursively sanitize arrays/objects
 * - key-aware masking for known sensitive fields
 * - safe against circular refs
 */
export function sanitizeErrors(value: any): any {
  const seen = new WeakSet();

  const walk = (v: any, key?: string): any => {
    if (v === null || v === undefined) return v;

    // primitives
    if (typeof v === "string" || typeof v === "number") {
      // If key is sensitive, always mask aggressively
      if (key && SENSITIVE_KEY_REGEX.test(key)) return maskPII(v);
      // Otherwise still mask digit sequences/emails inside strings (safe default)
      return maskPII(v);
    }

    if (typeof v === "boolean") return v;

    // arrays
    if (Array.isArray(v)) return v.map((item) => walk(item));

    // objects (with circular protection)
    if (typeof v === "object") {
      if (seen.has(v)) return "[Circular]";
      seen.add(v);

      const out: Record<string, any> = {};
      for (const k of Object.keys(v)) {
        out[k] = walk(v[k], k);
      }
      return out;
    }

    return v;
  };

  try {
    return walk(value);
  } catch {
    return maskPII(String(value));
  }
}